<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>夜のあかり｜静かなオンライン居場所</title>
<meta name="description" content="誰かが「おる」だけで灯る、会話のないオンライン居場所。静かな時間を共有します。">

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app-check.js"></script>

<style>
body {
  background-color: #0b0e1a;
  color: #ffd27d;
  font-size: 28px;
  padding: 20px;
  margin: 0;
  height: 100vh;
  overflow: hidden;
}

button {
  font-size: 1.2em;
  padding: 0.6em 1.2em;
}

#dots {
  position: relative;
  width: 100%;
  height: calc(100vh - 120px);
}

/* 蝋燭 */
.candle {
  position: absolute;
  width: 3vw;
  height: 6vw;
  max-width: 16px;
  max-height: 32px;
  border-radius: 50% 50% 60% 60%;
  background: radial-gradient(circle at 50% 20%, #fff, #ff9b5a);
  animation-name: flicker, breathe;
  animation-iteration-count: infinite;
}

@keyframes flicker {
  0%   { transform: scale(1) translateY(0); opacity: 0.9; }
  50%  { transform: scale(0.9) translateY(1px); opacity: 0.7; }
  100% { transform: scale(1) translateY(0); opacity: 0.9; }
}

@keyframes breathe {
  0%   { box-shadow: 0 0 6px rgba(255,180,80,0.6); }
  50%  { box-shadow: 0 0 14px rgba(255,180,80,0.9); }
  100% { box-shadow: 0 0 6px rgba(255,180,80,0.6); }
}
</style>
</head>

<body>

<div id="dots"></div>
<button id="hereBtn" onclick="imHere()">おる</button>

<script>
/* ===== Firebase設定 ===== */
var firebaseConfig = {
    apiKey: "AIzaSyCGl6i7ca_9tBrLTjR9bjqJSxkcKOFNoDo",
    authDomain: "yoru-no-akari.firebaseapp.com",
    databaseURL: "https://yoru-no-akari-default-rtdb.firebaseio.com",
    projectId: "yoru-no-akari",
    storageBucket: "yoru-no-akari.firebasestorage.app",
    messagingSenderId: "365296381564",
    appId: "1:365296381564:web:f23e3c3db11682f805e3f9"
};

firebase.initializeApp(firebaseConfig);

/* ===== App Check ===== */
firebase.appCheck().activate(
  "6LeFA0osAAAAABNtnCJcE2KUoWzRtnHkr9J5WT1W",
  false   // ← 本番。灯らん時だけ true にして様子見る
);

var db = firebase.database();

/* ===== App Check準備完了フラグ ===== */
var appCheckReady = false;
firebase.appCheck().onTokenChanged(function () {
  appCheckReady = true;
});

/* ===== 自分用の灯り ===== */
var myRef = null;

/* ===== 「おる」 ===== */
function imHere() {
  if (!appCheckReady) return;

  // まだ灯りが無いときだけ作る
  if (!myRef) {
    myRef = db.ref("presence/users").push();
    myRef.onDisconnect().remove();
  }

  // 押すたびに位置を更新する
  myRef.set({
    x: Math.random(),
    y: Math.random(),
    t: Date.now()
  });
}

/* ===== 表示 ===== */
db.ref("presence/users").on("value", function(snapshot){
  var box = document.getElementById("dots");
  box.innerHTML = "";

  var boxW = box.clientWidth;
  var boxH = box.clientHeight;

  snapshot.forEach(function(child){
    var data = child.val();
    if (!data) return;

    var d = document.createElement("div");
    d.className = "candle";

    d.style.left = (data.x * boxW) + "px";
    d.style.top  = (data.y * boxH) + "px";

    d.style.animationDuration =
      (1.5 + Math.random()) + "s, " +
      (3 + Math.random() * 2) + "s";

    box.appendChild(d);
  });
});
</script>

</body>
</html>
