<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>夜のあかり｜安全版</title>

<meta name="description" content="夜のあかりは、誰かが「おる」だけで灯る、会話のないオンライン居場所です。">

<!-- Firebase v9 -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app-check.js";

  // Firebase 設定
  const firebaseConfig = {
    apiKey: "AIzaSyCGl6i7ca_9tBrLTjR9bjqJSxkcKOFNoDo",
    authDomain: "yoru-no-akari.firebaseapp.com",
    databaseURL: "https://yoru-no-akari-default-rtdb.firebaseio.com",
    projectId: "yoru-no-akari",
    storageBucket: "yoru-no-akari.firebasestorage.app",
    messagingSenderId: "365296381564",
    appId: "1:365296381564:web:3f990dfb5b29b25405e3f9"
  };

  // Firebase 初期化
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // App Check 初期化
  const appCheck = initializeAppCheck(app, {
    provider: new ReCaptchaV3Provider('6Led9kksAAAAAMKJW3q4xetIFUF2UqfvHhcYLYK5'),
    isTokenAutoRefreshEnabled: true
  });

  // おる用
  const myRef = push(ref(db, "presence/users"));

  window.imHere = function() {
    const box = document.getElementById("dots");
    const w = box.clientWidth;
    const h = box.clientHeight;

    const xRate = Math.random();
    const yRate = Math.random();

    set(myRef, { x: xRate, y: yRate });
    onDisconnect(myRef).remove();
  };

  // 人数を見る
  const dotsBox = document.getElementById("dots");
  onValue(ref(db, "presence/users"), (snapshot) => {
    dotsBox.innerHTML = "";
    snapshot.forEach((child) => {
      const data = child.val();
      const d = document.createElement("div");
      d.className = "candle";

      const boxW = dotsBox.clientWidth;
      const boxH = dotsBox.clientHeight;

      d.style.left = (data.x * boxW) + "px";
      d.style.top  = (data.y * boxH) + "px";
      d.style.animationDuration =
        (1.5 + Math.random()) + "s, " +
        (3 + Math.random()*2) + "s";

      dotsBox.appendChild(d);
    });
  });
</script>

<style>
body {
  background-color: #0b0e1a;
  color: #ffd27d;
  font-size: 28px;
  padding: 20px;
  height: 100vh;
  overflow: hidden;
}

button {
  font-size: 1.2em;
  padding: 0.6em 1.2em;
}

#dots {
  position: relative;
  width: 100%;
  height: calc(100vh - 120px);
}

.candle {
  position: absolute;
  width: 3vw;
  height: 6vw;
  max-width: 14px;
  max-height: 28px;
  border-radius: 50% 50% 60% 60%;
  background: radial-gradient(circle at 50% 20%, #fff, #ff9b5a);
  animation-name: flicker, breathe;
  animation-duration: 2s, 4s;
  animation-iteration-count: infinite;
}

@keyframes flicker {
  0%   { transform: scale(1) translateY(0); opacity: 0.9; }
  50%  { transform: scale(0.9) translateY(1px); opacity: 0.7; }
  100% { transform: scale(1) translateY(0); opacity: 0.9; }
}

@keyframes breathe {
  0%   { box-shadow: 0 0 6px rgba(255,180,80,0.6); }
  50%  { box-shadow: 0 0 14px rgba(255,180,80,0.9); }
  100% { box-shadow: 0 0 6px rgba(255,180,80,0.6); }
}
</style>

</head>
<body>

<div id="dots"></div>
<button onclick="imHere()">おる</button>

</body>
</html>
